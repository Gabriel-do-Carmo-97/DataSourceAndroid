name: Android Libs CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  # Job 1: Apenas detecta quais m√≥dulos foram alterados
  check_changes:
    name: 1. Detect Changed Modules
    runs-on: ubuntu-latest
    outputs:
      aws_changed: ${{ steps.aws_files.outputs.any_changed }}
      appwrite_changed: ${{ steps.appwrite_files.outputs.any_changed }}
      firebase_changed: ${{ steps.firebase_files.outputs.any_changed }}
      mongodb_changed: ${{ steps.mongodb_files.outputs.any_changed }}
      supabase_changed: ${{ steps.supabase_files.outputs.any_changed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect changes in amplifyAws-sdk
        id: aws_files
        uses: tj-actions/changed-files@v47
        with:
          files: amplifyAws-sdk/**

      - name: Detect changes in appwrite-sdk
        id: appwrite_files
        uses: tj-actions/changed-files@v47
        with:
          files: appwrite-sdk/**

      - name: Detect changes in firebase-sdk
        id: firebase_files
        uses: tj-actions/changed-files@v47
        with:
          files: firebase-sdk/**

      - name: Detect changes in mongoDb-sdk
        id: mongodb_files
        uses: tj-actions/changed-files@v47
        with:
          files: mongoDb-sdk/**

      - name: Detect changes in supabase
        id: supabase_files
        uses: tj-actions/changed-files@v47
        with:
          files: supabase/**

  # --- Jobs de Build e Publish --- #

  build_and_publish_aws:
    name: 2. Build & Publish AWS
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.aws_changed == 'true'
    permissions:
      contents: write
      packages: write
    steps: 
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with: { java-version: '17', distribution: 'temurin', cache: gradle }
      - uses: android-actions/setup-android@v3
      - run: ./gradlew :amplifyAws-sdk:build
      - name: Publish
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        env: { GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
        run: ./gradlew :amplifyAws-sdk:publish

  build_and_publish_appwrite:
    name: 2. Build & Publish Appwrite
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.appwrite_changed == 'true'
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with: { java-version: '17', distribution: 'temurin', cache: gradle }
      - uses: android-actions/setup-android@v3
      - run: ./gradlew :appwrite-sdk:build
      - name: Publish
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        env: { GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
        run: ./gradlew :appwrite-sdk:publish

  build_and_publish_firebase:
    name: 2. Build & Publish Firebase
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.firebase_changed == 'true'
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with: { java-version: '17', distribution: 'temurin', cache: gradle }
      - uses: android-actions/setup-android@v3
      - run: ./gradlew :firebase-sdk:build
      - name: Publish
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        env: { GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
        run: ./gradlew :firebase-sdk:publish

  build_and_publish_mongodb:
    name: 2. Build & Publish MongoDB
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.mongodb_changed == 'true'
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with: { java-version: '17', distribution: 'temurin', cache: gradle }
      - uses: android-actions/setup-android@v3
      - run: ./gradlew :mongoDb-sdk:build
      - name: Publish
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        env: { GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
        run: ./gradlew :mongoDb-sdk:publish

  build_and_publish_supabase:
    name: 2. Build & Publish Supabase
    runs-on: ubuntu-latest
    needs: check_changes
    if: needs.check_changes.outputs.supabase_changed == 'true'
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with: { java-version: '17', distribution: 'temurin', cache: gradle }
      - uses: android-actions/setup-android@v3
      - run: ./gradlew :supabase:build
      - name: Publish
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        env: { GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
        run: ./gradlew :supabase:publish
