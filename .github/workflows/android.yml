name: Android Libs CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  # --- Job de Setup ---
  setup:
    name: 0. Setup
    runs-on: ubuntu-latest
    outputs:
      version_name: ${{ steps.version.outputs.VERSION_NAME }}
    steps:
      - id: version
        name: Create Version Name
        run: echo "VERSION_NAME=0.0.${{ github.run_number }}" >> $GITHUB_OUTPUT

  # --- Jobs de Verificação (rodam em paralelo) ---
  check_change_aws:
    name: 1. Check AWS Changes
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.files.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v5
        with: { fetch-depth: 0 }
      - id: files
        uses: tj-actions/changed-files@v47
        with:
          files: amplifyAws-sdk/**

  check_change_appwrite:
    name: 1. Check Appwrite Changes
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.files.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v5
        with: { fetch-depth: 0 }
      - id: files
        uses: tj-actions/changed-files@v47
        with:
          files: appwrite-sdk/**

  check_change_firebase:
    name: 1. Check Firebase Changes
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.files.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v5
        with: { fetch-depth: 0 }
      - id: files
        uses: tj-actions/changed-files@v47
        with:
          files: firebase-sdk/**

  check_change_mongodb:
    name: 1. Check MongoDB Changes
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.files.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v5
        with: { fetch-depth: 0 }
      - id: files
        uses: tj-actions/changed-files@v47
        with:
          files: mongoDb-sdk/**

  check_change_supabase:
    name: 1. Check Supabase Changes
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.files.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v5
        with: { fetch-depth: 0 }
      - id: files
        uses: tj-actions/changed-files@v47
        with:
          files: supabase/**

  # --- Jobs de Build (rodam em paralelo, se ativados) ---
  build_aws:
    name: 2. Build AWS
    runs-on: ubuntu-latest
    needs: [setup, check_change_aws]
    if: needs.check_change_aws.outputs.changed == 'true'
    permissions: { contents: read }
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - uses: android-actions/setup-android@v3
      - run: ./gradlew :amplifyAws-sdk:build -Pversion_name=${{ needs.setup.outputs.version_name }}
      - uses: actions/upload-artifact@v4
        with: { name: aws-aar, path: 'amplifyAws-sdk/build/outputs/aar/*.aar' }

  build_appwrite:
    name: 2. Build Appwrite
    runs-on: ubuntu-latest
    needs: [setup, check_change_appwrite]
    if: needs.check_change_appwrite.outputs.changed == 'true'
    permissions: { contents: read }
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - uses: android-actions/setup-android@v3
      - run: ./gradlew :appwrite-sdk:build -Pversion_name=${{ needs.setup.outputs.version_name }}
      - uses: actions/upload-artifact@v4
        with: { name: appwrite-aar, path: 'appwrite-sdk/build/outputs/aar/*.aar' }

  build_firebase:
    name: 2. Build Firebase
    runs-on: ubuntu-latest
    needs: [setup, check_change_firebase]
    if: needs.check_change_firebase.outputs.changed == 'true'
    permissions: { contents: read }
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - uses: android-actions/setup-android@v3
      - run: ./gradlew :firebase-sdk:build -Pversion_name=${{ needs.setup.outputs.version_name }}
      - uses: actions/upload-artifact@v4
        with: { name: firebase-aar, path: 'firebase-sdk/build/outputs/aar/*.aar' }

  build_mongodb:
    name: 2. Build MongoDB
    runs-on: ubuntu-latest
    needs: [setup, check_change_mongodb]
    if: needs.check_change_mongodb.outputs.changed == 'true'
    permissions: { contents: read }
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - uses: android-actions/setup-android@v3
      - run: ./gradlew :mongoDb-sdk:build -Pversion_name=${{ needs.setup.outputs.version_name }}
      - uses: actions/upload-artifact@v4
        with: { name: mongodb-aar, path: 'mongoDb-sdk/build/outputs/aar/*.aar' }

  build_supabase:
    name: 2. Build Supabase
    runs-on: ubuntu-latest
    needs: [setup, check_change_supabase]
    if: needs.check_change_supabase.outputs.changed == 'true'
    permissions: { contents: read }
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - uses: android-actions/setup-android@v3
      - run: ./gradlew :supabase:build -Pversion_name=${{ needs.setup.outputs.version_name }}
      - uses: actions/upload-artifact@v4
        with: { name: supabase-aar, path: 'supabase/build/outputs/aar/*.aar' }

  # --- Jobs de Publish (rodam em paralelo, se ativados) ---
  publish_aws:
    name: 3. Publish AWS
    runs-on: ubuntu-latest
    needs: [setup, build_aws]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions: { packages: write }
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew :amplifyAws-sdk:publish -Pversion_name=${{ needs.setup.outputs.version_name }}

  publish_appwrite:
    name: 3. Publish Appwrite
    runs-on: ubuntu-latest
    needs: [setup, build_appwrite]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions: { packages: write }
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew :appwrite-sdk:publish -Pversion_name=${{ needs.setup.outputs.version_name }}

  publish_firebase:
    name: 3. Publish Firebase
    runs-on: ubuntu-latest
    needs: [setup, build_firebase]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions: { packages: write }
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew :firebase-sdk:publish -Pversion_name=${{ needs.setup.outputs.version_name }}

  publish_mongodb:
    name: 3. Publish MongoDB
    runs-on: ubuntu-latest
    needs: [setup, build_mongodb]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions: { packages: write }
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew :mongoDb-sdk:publish -Pversion_name=${{ needs.setup.outputs.version_name }}

  publish_supabase:
    name: 3. Publish Supabase
    runs-on: ubuntu-latest
    needs: [setup, build_supabase]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions: { packages: write }
    steps:
      - uses: actions/checkout@v5
      - run: chmod +x gradlew
      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew :supabase:publish -Pversion_name=${{ needs.setup.outputs.version_name }}

  # --- Jobs Finais de Release ---
  create_tag:
    name: 4. Create Git Tag
    runs-on: ubuntu-latest
    needs: [setup, check_change_aws, check_change_appwrite, check_change_firebase, check_change_mongodb, check_change_supabase, build_aws, build_appwrite, build_firebase, build_mongodb, build_supabase, publish_aws, publish_appwrite, publish_firebase, publish_mongodb, publish_supabase]
    if: >
      always() && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
      (needs.check_change_aws.outputs.changed == 'true' ||
       needs.check_change_appwrite.outputs.changed == 'true' ||
       needs.check_change_firebase.outputs.changed == 'true' ||
       needs.check_change_mongodb.outputs.changed == 'true' ||
       needs.check_change_supabase.outputs.changed == 'true')
    permissions: { contents: write }
    outputs:
      tag_name: ${{ steps.tag_version.outputs.TAG_NAME }}
    steps:
      - uses: actions/checkout@v5
      - name: Configure Git User
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - id: tag_version
        name: Create and Push Git Tag
        run: |
          TAG_NAME="v${{ needs.setup.outputs.version_name }}"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"

  create_release:
    name: 5. Create GitHub Release
    runs-on: ubuntu-latest
    needs: create_tag
    if: always() && needs.create_tag.result == 'success'
    permissions: { contents: write }
    steps:
      - uses: actions/checkout@v5
      - uses: actions/download-artifact@v4
        with: { path: ./artifacts }
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.create_tag.outputs.tag_name }}
        run: |
          files_to_upload=$(find ./artifacts -name "*.aar" | tr '\n' ' ')
          gh release create "$TAG" \
            --title "Release $TAG" \
            --notes "Release automática dos módulos publicados." \
            $files_to_upload
